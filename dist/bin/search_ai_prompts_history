#!/usr/bin/env bash
#
# Codex CLI / Claude Code に過去に入力したプロンプトを検索する
#
# 対応ツール:
#   - Codex CLI  (~/.codex/sessions/*.jsonl)
#   - Claude Code (~/.claude/projects/*/*.jsonl)
#
# 依存コマンド:
#   - jq: https://github.com/jqlang/jq
#   - fzf: https://github.com/junegunn/fzf
#

set -euo pipefail

# 必要なコマンドの存在チェック
required_commands=("jq" "fzf")
missing_commands=()

for cmd in "${required_commands[@]}"; do
  if ! command -v "$cmd" &>/dev/null; then
    missing_commands+=("$cmd")
  fi
done

if [[ ${#missing_commands[@]} -gt 0 ]]; then
  echo "Error: Required command(s) not found: ${missing_commands[*]}" >&2
  echo "Please install the missing command(s) and try again." >&2
  exit 1
fi

# 検索対象ディレクトリの収集（存在するもののみ）
find_targets=()
[[ -d ~/.codex/sessions ]] && find_targets+=(~/.codex/sessions)
[[ -d ~/.claude/projects ]] && find_targets+=(~/.claude/projects)

if [[ ${#find_targets[@]} -eq 0 ]]; then
  echo "Error: No history directories found." >&2
  echo "Expected: ~/.codex/sessions or ~/.claude/projects" >&2
  exit 1
fi

find "${find_targets[@]}" -type f -name '*.jsonl' ! -name 'agent-*.jsonl' -exec stat -f '%m %N' {} + \
  | sort -rn \
  | cut -d' ' -f2- \
  | while IFS= read -r f; do
      tail -r -- "$f"
    done \
  | jq -r '
      # Codex CLI 形式: {"payload": {"type": "user_message", "message": "..."}}
      def extract_codex_prompt:
        .payload.message;

      # Claude Code 形式: {"type": "user", "message": {"content": "..." | [...]}}
      def extract_claude_prompt:
        .message.content
        | if type == "array" then
            [.[] | select(.type == "text") | .text] | join("\n")
          else
            .
          end;

      # fzf 用に表示テキストと Base64 エンコードしたテキストを区切り文字で結合する
      # $prefix は表示用テキストにのみ付与し、Base64 側には含めない
      def format_for_fzf($prefix):
        ($prefix + gsub("\n"; "\\n")) + "\u001f" + @base64;

      if .payload.type == "user_message" then
        extract_codex_prompt | select(. != "") | format_for_fzf("Codex  | ")
      elif .type == "user" then
        extract_claude_prompt | select(. != "") | format_for_fzf("Claude | ")
      else empty
      end
    ' \
  | fzf --delimiter $'\x1f' --with-nth=1 --accept-nth=2 \
        --preview 'printf "%s" {2} | base64 --decode' \
        --preview-window=wrap \
  | base64 --decode \
  | pbcopy
